<!DOCTYPE html>

<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zero@Factory â€” Production Flow Live</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --zero-navy: #02154e;
      --zero-orange: #f9ba00;
      --zero-green: #005530;
      --zero-red: #D51635;
      --zero-white: #ffffff;
      --zero-black: #1a1a1a;
      --zero-gray-dark: #666666;
      --zero-gray-light: #e0e0e0;
      --zero-gray-bg: #fafafa;
    }

    .top-nav{background:var(--zero-white);border-bottom:1px solid var(--zero-gray-light);display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;padding:.5rem 1rem}
    .nav-link{display:inline-flex;align-items:center;gap:.35rem;padding:.5rem .9rem;border:none;border-radius:6px;background:var(--zero-navy);color:#fff;text-decoration:none;font-size:.85rem}
    .nav-link:hover{background:var(--zero-orange);color:var(--zero-navy)}
    .nav-link.active{background:var(--zero-green);color:#fff}
    .icon{width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2}
    .nav-link:hover .icon{stroke:var(--zero-navy)}
    .icon.token{stroke:var(--zero-navy)}
    .token-badge .icon{stroke:var(--zero-navy);width:12px;height:12px}
    /* PATCH START: Flow Cards + Token Info Fix */
    .flow-kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:.45rem;margin:.35rem 0 .55rem 0;padding:0}
    .kpi-mini{background:#fff;border:1px solid var(--zero-gray-light);border-radius:10px;padding:.30rem .50rem;min-height:36px;display:flex;flex-direction:column;gap:.08rem;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .kpi-title{font-size:.7rem;color:var(--zero-gray-dark);line-height:1.1}
    .kpi-value{font-size:.88rem;font-weight:800;color:var(--zero-navy);line-height:1.1}
    @media (max-width: 820px){ .flow-kpi{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 560px){ .flow-kpi{grid-template-columns:1fr} }
    .order-token{z-index:20;pointer-events:auto}
    .token-chip{position:fixed;left:0;top:0;transform:translate(-50%,-100%);background:#fff;border:1px solid var(--zero-gray-light);border-radius:10px;padding:.35rem .55rem;font-size:.74rem;line-height:1.1;box-shadow:0 10px 22px rgba(0,0,0,.18);white-space:nowrap;max-width:260px;overflow:hidden;text-overflow:ellipsis;z-index:9999;pointer-events:none}
    .token-chip:after{content:"";position:absolute;left:50%;bottom:-6px;transform:translateX(-50%);border:6px solid transparent;border-top-color:#fff;filter:drop-shadow(0 -1px 0 rgba(0,0,0,.12))}
    .order-popup{position:absolute;background:#fff;border:1px solid var(--zero-gray-light);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.22);width:340px;max-width:92vw;z-index:40}
    .order-popup.center{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%)}
    .op-head{display:flex;justify-content:space-between;align-items:center;padding:.6rem .9rem;background:#fafbfc;border-bottom:1px solid var(--zero-gray-light)}
    .op-body{padding:.9rem}
    .op-tabs{display:flex;gap:.5rem;margin:.4rem 0}
    .op-tab{padding:.25rem .5rem;border:1px solid var(--zero-gray-light);border-radius:999px;background:#fff;color:var(--zero-navy);cursor:pointer}
    .op-tab.active{background:#02154e;color:#fff;border-color:#02154e}
    /* PATCH END: Flow Cards + Token Info Fix */
    /* PATCH START: Full Width Timeline */
    .fw-tl-wrap{margin:0 -2rem;padding:.3rem 2rem .2rem}
    .fw-tl-bar{display:grid;grid-template-columns:280px 1fr 380px;align-items:center;gap:.75rem;background:#fff;border-top:1px solid var(--zero-gray-light);border-bottom:1px solid var(--zero-gray-light)}
    .fw-pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border-radius:999px;background:#f5f7fa;color:var(--zero-navy);border:1px solid var(--zero-gray-light);font-size:.8rem}
    .fw-track{position:relative;height:12px;background:#eef1f4;border-radius:999px}
    .fw-progress{position:absolute;left:0;top:0;height:12px;background:var(--zero-green);border-radius:999px}
    .fw-now{position:absolute;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#fff;border:2px solid var(--zero-green);box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .fw-eta{margin-top:.25rem;font-size:.75rem;color:var(--zero-gray-dark)}
    .fw-right{display:flex;align-items:center;gap:.5rem;justify-content:flex-end}
    .fw-mode{display:inline-flex;gap:.35rem}
    .fw-btn{padding:.25rem .6rem;border:1px solid var(--zero-gray-light);border-radius:999px;background:#fafbfc;color:var(--zero-navy);cursor:pointer;font-size:.8rem}
    .fw-btn.active{background:var(--zero-navy);color:#fff;border-color:var(--zero-navy)}
    .fw-queue{display:flex;align-items:center;gap:.4rem;margin:.35rem -2rem 0 -2rem;padding:0 2rem}
    .fw-q-token{padding:.2rem .5rem;border:1px solid var(--zero-gray-light);border-radius:999px;background:#fff;color:var(--zero-navy);font-size:.78rem;cursor:pointer}
    .fw-q-more{padding:.2rem .6rem;border-radius:999px;background:#f5f7fa;color:var(--zero-gray-dark);border:1px solid var(--zero-gray-light)}
    @media (max-width: 900px){ .fw-tl-bar{grid-template-columns:220px 1fr 260px} }
    /* PATCH END: Full Width Timeline */
    .icon-dot{width:8px;height:8px;border-radius:50%;background:var(--zero-navy);display:inline-block}
    * { margin: 0; padding: 0; box-sizing: border-box; }
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
  background: var(--zero-gray-bg);
  color: var(--zero-black);
  line-height: 1.6;
  padding-top: 4px;
}

.zero-color-bar {
  height: 4px;
  width: 100%;
  background: linear-gradient(90deg, 
    var(--zero-green) 0%, var(--zero-green) 25%, 
    var(--zero-red) 25%, var(--zero-red) 50%, 
    var(--zero-navy) 50%, var(--zero-navy) 75%, 
    var(--zero-orange) 75%, var(--zero-orange) 100%);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
}

.app-header {
  background: var(--zero-white);
  color: var(--zero-navy);
  padding: 1.5rem 2rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border-bottom: 1px solid var(--zero-gray-light);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1600px;
  margin: 0 auto;
  flex-wrap: wrap;
  gap: 1rem;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 2rem;
  flex-wrap: wrap;
}

.title {
  font-size: 1.3rem;
  font-weight: 300;
  color: var(--zero-navy);
}

.title-at { 
  color: var(--zero-orange);
  font-weight: 400;
}

.shift-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.5rem 1rem;
  background: var(--zero-gray-bg);
  border: 1px solid var(--zero-gray-light);
  border-radius: 6px;
  font-size: 0.85rem;
}

.shift-badge {
  padding: 0.25rem 0.75rem;
  background: var(--zero-navy);
  color: var(--zero-white);
  border-radius: 4px;
  font-weight: 600;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
}

.shift-time {
  font-size: 0.8rem;
  color: var(--zero-gray-dark);
}

.header-controls {
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}

.speed-control {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  font-size: 0.8rem;
  color: var(--zero-gray-dark);
}

.speed-btn {
  padding: 0.35rem 0.75rem;
  border: 1px solid var(--zero-gray-light);
  border-radius: 4px;
  background: var(--zero-white);
  color: var(--zero-navy);
  cursor: pointer;
  font-size: 0.75rem;
  font-weight: 500;
  transition: all 0.3s ease;
  font-family: inherit;
}

.speed-btn:hover {
  background: var(--zero-gray-bg);
  border-color: var(--zero-navy);
}

.speed-btn.active {
  background: var(--zero-navy);
  color: var(--zero-white);
  border-color: var(--zero-navy);
}

.alert-toggle {
  padding: 0.5rem 1rem;
  background: var(--zero-white);
  border: 1px solid var(--zero-gray-light);
  border-radius: 6px;
  color: var(--zero-navy);
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
  font-family: inherit;
}

.alert-toggle:hover {
  background: var(--zero-gray-bg);
}

.alert-toggle.active {
  background: var(--zero-green);
  color: var(--zero-white);
  border-color: var(--zero-green);
}

.legend {
  display: flex;
  gap: 1rem;
  font-size: 0.75rem;
  color: var(--zero-gray-dark);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.main-container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 2rem;
  display: grid;
  grid-template-rows: auto 1fr 280px;
  gap: 1.5rem;
  min-height: calc(100vh - 100px);
}

.flow-section {
  background: var(--zero-white);
  border: 1px solid var(--zero-gray-light);
  border-radius: 8px;
  padding: 2rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  overflow: hidden;
  position: relative;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--zero-orange);
}

.section-title {
  font-size: 1.1rem;
  font-weight: 400;
  color: var(--zero-navy);
}

.live-indicator {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  color: var(--zero-green);
  font-weight: 600;
  letter-spacing: 1px;
}

.live-dot {
  width: 6px;
  height: 6px;
  background: var(--zero-green);
  border-radius: 50%;
  animation: livePulse 2s infinite;
}

@keyframes livePulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(1.4); }
}

.flow-lanes {
  position: relative;
  height: 100%;
  overflow-y: auto;
}

.flow-lane {
  position: relative;
  height: 90px;
  margin-bottom: 1rem;
  border-bottom: 1px dashed var(--zero-gray-light);
}

.flow-lane:last-child { border-bottom: none; }

.lane-header {
  position: absolute;
  left: 0;
  top: 0;
  width: 240px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 1rem;
  background: linear-gradient(90deg, var(--zero-gray-bg) 0%, rgba(250,250,250,0) 100%);
  z-index: 5;
}

.lane-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.5rem;
}

.lane-number {
  font-size: 1.8rem;
  font-weight: 300;
  color: var(--zero-navy);
  line-height: 1;
  min-width: 28px;
}

.lane-name {
  font-size: 0.85rem;
  font-weight: 400;
  color: var(--zero-navy);
}

.lane-status {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.7rem;
  color: var(--zero-gray-dark);
  margin-bottom: 0.3rem;
}

.status-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

.status-dot.running { background: var(--zero-green); }
.status-dot.down { background: var(--zero-red); }

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.lane-operator {
  font-size: 0.7rem;
  color: var(--zero-gray-dark);
  margin-bottom: 0.3rem;
}

.operator-name {
  font-weight: 500;
  color: var(--zero-navy);
}

.lane-metrics {
  display: flex;
  gap: 0.75rem;
  font-size: 0.7rem;
  color: var(--zero-gray-dark);
}

.lane-metric strong {
  color: var(--zero-navy);
  font-weight: 600;
}

.lane-track {
  position: absolute;
  left: 260px;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  height: 2px;
  background: var(--zero-gray-light);
  border-radius: 1px;
}

.lane-stations {
  position: absolute;
  left: 260px;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  justify-content: space-between;
  z-index: 10;
}

.station-checkpoint {
  width: 18px;
  height: 18px;
  background: var(--zero-white);
  border: 2px solid var(--zero-navy);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.65rem;
  font-weight: 600;
  color: var(--zero-navy);
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.station-checkpoint:hover {
  transform: scale(1.3);
  z-index: 100;
  box-shadow: 0 2px 8px rgba(2,21,78,0.2);
}

.station-checkpoint.active {
  background: var(--zero-green);
  border-color: var(--zero-green);
  color: var(--zero-white);
}

.station-checkpoint.down {
  background: var(--zero-red);
  border-color: var(--zero-red);
  color: var(--zero-white);
  animation: stationAlert 1s infinite;
}

@keyframes stationAlert {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.order-token {
  position: absolute;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  z-index: 20;
  top: 50%;
  transform: translate(-50%, -50%);
  background: var(--zero-white);
  border: 3px solid var(--zero-navy);
}

.order-token:hover {
  transform: translate(-50%, -50%) scale(1.2);
  z-index: 100;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
}

.order-token.ok {
  border-color: var(--zero-green);
  background: var(--zero-white);
}

.order-token.warning {
  border-color: var(--zero-orange);
  background: var(--zero-white);
}

.order-token.critical {
  border-color: var(--zero-red);
  background: var(--zero-white);
}

.order-token.blocked {
  border-color: var(--zero-navy);
  background: rgba(2,21,78,0.1);
  animation: shake 0.5s infinite;
}

@keyframes shake {
  0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
  25% { transform: translate(-50%, -50%) rotate(-1deg); }
  75% { transform: translate(-50%, -50%) rotate(1deg); }
}

.token-badge {
  position: absolute;
  top: -3px;
  right: -3px;
  width: 14px;
  height: 14px;
  background: var(--zero-white);
  border: 2px solid var(--zero-navy);
  border-radius: 50%;
  font-size: 0.65rem;
  font-weight: 700;
  color: var(--zero-navy);
  display: flex;
  align-items: center;
  justify-content: center;
}

.station-section {
  background: var(--zero-white);
  border: 1px solid var(--zero-gray-light);
  border-radius: 8px;
  padding: 1.5rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  overflow-y: auto;
}

.station-grid{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-top: 1rem;
position:relative;}

  .no-data-overlay{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.86);
    color:#02154e; font-weight:700;
    text-align:center; padding:1rem;
    border-radius:12px;
  }
  .no-data-overlay .sub{font-weight:600;color:#444;margin-top:.45rem;font-size:.92rem}


.station-card {
  background: var(--zero-gray-bg);
  border: 1px solid var(--zero-gray-light);
  border-radius: 6px;
  padding: 1.5rem;
  border-left: 3px solid var(--zero-navy);
  transition: all 0.2s;
  cursor: pointer;
}



  /* PATCH: station row layout fix (Operator/WIP/OEE spacing) */
  .st-body{display:flex;flex-direction:column;gap:8px;margin-top:10px;}
  .st-row{display:flex;align-items:center;justify-content:space-between;gap:10px;line-height:1.2;}
  .st-row .k{color:#5b667a;font-weight:600;}
  .st-row .v{color:var(--zero-navy);font-weight:700;}

.station-card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  transform: translateY(-2px);
}

.station-card.down { border-left-color: var(--zero-red); }
.station-card.warning { border-left-color: var(--zero-orange); }

.station-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.station-name {
  font-size: 0.95rem;
  font-weight: 500;
  color: var(--zero-navy);
}

.station-line {
  font-size: 0.7rem;
  color: var(--zero-gray-dark);
  background: var(--zero-white);
  padding: 0.2rem 0.6rem;
  border-radius: 3px;
  border: 1px solid var(--zero-gray-light);
}

.station-operator-info {
  font-size: 0.75rem;
  color: var(--zero-gray-dark);
  margin-bottom: 0.75rem;
}

.machines-list {
  margin: 1rem 0;
}

.machine-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.6rem;
  margin: 0.3rem 0;
  background: var(--zero-white);
  border-radius: 4px;
  font-size: 0.8rem;
  border: 1px solid var(--zero-gray-light);
}

.machine-name {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  font-weight: 500;
  color: var(--zero-navy);
}

.machine-status {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.75rem;
  color: var(--zero-gray-dark);
}

.machine-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.machine-dot.running { background: var(--zero-green); }
.machine-dot.down { background: var(--zero-red); }
.machine-dot.maintenance { background: var(--zero-orange); }

.station-metrics {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.75rem;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--zero-gray-light);
}

.metric-item {
  text-align: center;
}

.metric-label {
  font-size: 0.7rem;
  color: var(--zero-gray-dark);
  margin-bottom: 0.2rem;
}

.metric-value {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--zero-navy);
}

.alert-notification {
  position: fixed;
  top: 100px;
  right: 20px;
  width: 340px;
  background: var(--zero-white);
  border-left: 4px solid var(--zero-red);
  border-radius: 6px;
  padding: 1.25rem;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  transform: translateX(400px);
  transition: transform 0.3s;
  z-index: 2000;
}

.alert-notification.show {
  transform: translateX(0);
}

.alert-notif-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.alert-notif-title {
  font-weight: 600;
  color: var(--zero-navy);
  font-size: 0.9rem;
}

.alert-notif-close {
  background: none;
  border: none;
  font-size: 1.3rem;
  color: var(--zero-gray-dark);
  cursor: pointer;
  line-height: 1;
  transition: color 0.2s;
}

.alert-notif-close:hover {
  color: var(--zero-navy);
}

.alert-notif-message {
  font-size: 0.85rem;
  color: var(--zero-gray-dark);
  margin-bottom: 0.75rem;
  line-height: 1.5;
}

.alert-notif-time {
  font-size: 0.7rem;
  color: var(--zero-gray-dark);
}

@media (max-width: 1200px) {
  .main-container {
    grid-template-rows: auto 1fr;
  }
  .station-section {
    display: none;
  }
}

@media (max-width: 768px) {
  body { padding-top: 4px; }
  .app-header { padding: 1rem; }
  .header-content {
    flex-direction: column;
    align-items: stretch;
  }
  .header-left {
    flex-direction: column;
    gap: 0.75rem;
  }
  .header-controls {
    flex-wrap: wrap;
    justify-content: center;
  }
  .main-container {
    padding: 1rem;
  }
  .lane-header { width: 160px; }
  .lane-track, .lane-stations { left: 180px; }
  .order-token { width: 32px; height: 32px; font-size: 1rem; }
  .station-grid { grid-template-columns: 1fr; }
  .alert-notification { width: calc(100% - 40px); }
}
  

  </style>
</head>
<body>
  <div class="zero-color-bar"></div>

  <div class="alert-notification" id="alertNotif">
    <div class="alert-notif-header">
      <div class="alert-notif-title" id="alertTitle">ðŸ”´ Bildirim</div>
      <button class="alert-notif-close" onclick="closeAlert()">Ã—</button>
    </div>
    <div class="alert-notif-message" id="alertMessage">-</div>
    <div class="alert-notif-time" id="alertTime">-</div>
  </div>

  <header class="app-header">
    <div class="header-content">
      <div class="header-left">
        <div class="title">Zero<span class="title-at">@</span>Factory â€” Production Flow Live</div>
        <div class="shift-info">
          <span class="shift-badge" id="shiftBadge">1. VARDÄ°YA</span>
          <span class="shift-time" id="shiftTime">07:00 - 15:00</span>
        </div>
      </div>
      <div class="header-controls">
        <div class="speed-control">
          <span>HÄ±z:</span>
          <button class="speed-btn active" onclick="setSpeed(0.25)">0.25x</button>
          <button class="speed-btn" onclick="setSpeed(0.5)">0.5x</button>
          <button class="speed-btn" onclick="setSpeed(1)">1x</button>
          <button class="speed-btn" onclick="setSpeed(2)">2x</button>
        </div>
        <button class="alert-toggle" id="alertToggle" onclick="toggleAlerts()"><svg class="icon" viewBox="0 0 24 24"><path d="M12 3a6 6 0 016 6v4l2 3H4l2-3V9a6 6 0 016-6z"/><path d="M10 20h4"/></svg>Bildirimler</button>
        <div class="legend">
          <div class="legend-item"><div class="legend-dot" style="background: var(--zero-green);"></div><span>Normal</span></div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--zero-orange);"></div><span>UyarÄ±</span></div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--zero-red);"></div><span>Kritik</span></div>
        </div>
      </div>
    </div>
  </header>

  <nav class="top-nav">
    <a class="nav-link" href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M3 11h18M6 7h12M4 15h16"/></svg>Genel BakÄ±ÅŸ</a>
    <a class="nav-link" href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M5 5h14v14H5z"/><path d="M9 9l6 6"/></svg>Kalite</a>
    <a class="nav-link" href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M5 19l14-14"/><path d="M5 5l14 14"/></svg>BakÄ±m</a>
    <a class="nav-link" href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M4 19h16M4 12h16M4 5h16"/></svg>CFO</a>
    <a class="nav-link" href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M3 7h18"/><path d="M6 12h12"/><path d="M9 17h6"/></svg>Malzemeler</a>
    <a class="nav-link" href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M3 12h18"/><path d="M7 7h10"/><path d="M7 17h10"/></svg>Sevkiyat</a>
    <a class="nav-link" href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/></svg>Hat Takip</a>
    <a class="nav-link active" href="#"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><rect x="7" y="7" width="10" height="10" rx="3"/></svg>Ãœretim AkÄ±ÅŸ ÅžemasÄ±</a>
    <a class="nav-link" href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M4 18l6-6 4 4 6-6"/></svg>GeÃ§miÅŸ EÄŸilimler</a>
    <a class="nav-link" href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M4 19h16"/><path d="M4 12h12"/><path d="M4 5h8"/></svg>Ã‡oklu Site</a>
  </nav>

  <div class="main-container">
    <div class="flow-section">
      <div class="section-header">
        <div class="section-title">Ã‡amaÅŸÄ±r Makinesi Ãœretim AkÄ±ÅŸÄ± â€” GerÃ§ek ZamanlÄ±</div>
        <div class="live-indicator"><div class="live-dot"></div><span>CANLI</span></div>
      </div>
      <!-- PATCH START: Full Width Timeline -->
      <div id="fwTlHost" class="fw-tl-wrap">
        <div class="fw-tl-bar">
          <div class="fw-left"><span id="fwOrder" class="fw-pill">Order: -</span><span id="fwPerc" class="fw-pill">0%</span></div>
          <div class="fw-mid">
            <div class="fw-track"><div id="fwProg" class="fw-progress" style="width:0%"></div><div id="fwNow" class="fw-now" style="left:0%"></div></div>
            <div id="fwETA" class="fw-eta">ETA: -</div>
          </div>
          <div class="fw-right"><span id="fwQueueLbl" class="fw-pill">Queue: 0</span><div class="fw-mode"><button id="fwLive" class="fw-btn active">LIVE</button><button id="fwReplay" class="fw-btn">REPLAY</button></div><span id="fwSync" class="fw-pill">Last Sync: -</span></div>
        </div>
        <div id="fwQueue" class="fw-queue"></div>
      </div>
      <!-- PATCH END: Full Width Timeline -->
      <!-- PATCH START: Flow Cards + Token Info Fix -->
      <div id="flowMiniKPI" class="flow-kpi">
        <div class="kpi-mini"><div class="kpi-title">COâ‚‚e / unit</div><div id="kpiCO2" class="kpi-value">- kg</div></div>
        <div class="kpi-mini"><div class="kpi-title">OEE</div><div id="kpiOEE" class="kpi-value">- %</div></div>
        <div class="kpi-mini"><div class="kpi-title">ETA Drift</div><div id="kpiETA" class="kpi-value">On Track</div></div>
      </div>
      <!-- PATCH END: Flow Cards + Token Info Fix -->
      <div class="flow-lanes" id="flowLanes"></div>
    </div>

<div class="station-section">
  <div class="section-header">
    <div class="section-title">Ä°stasyon DurumlarÄ± â€” Makineler & OperatÃ¶rler</div>
  </div>
  <div class="station-grid" id="stationGrid"></div>
</div>

  </div>

  <script>
    const ICONS = {
      user: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 12c4 0 8 2 8 4v2H4v-2c0-2 4-4 8-4"/><circle cx="12" cy="7" r="4"/></svg>',
      washer: '<svg class="icon token" viewBox="0 0 24 24"><rect x="4" y="3" width="16" height="18" rx="2"/><circle cx="12" cy="12" r="5"/><path d="M8 6h2M14 6h2"/></svg>',
      check: '<svg class="icon" viewBox="0 0 24 24"><path d="M5 13l4 4 10-10"/></svg>',
      warn: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 3l9 16H3l9-16"/><path d="M12 10v4"/><circle cx="12" cy="17" r="1"/></svg>'
    };
    const operators = ['Ahmet Y.', 'Mehmet K.', 'Ali D.', 'AyÅŸe Åž.', 'Fatma Ã–.', 'Mustafa Ã‡.', 'Zeynep A.', 'HÃ¼seyin K.'];
    const lines = [
      { id: 1, name: 'Metal & Åžase', status: 'running', wip: 18, oee: 85, operator: operators[0] },
      { id: 2, name: 'Boya HattÄ±', status: 'down', wip: 6, oee: 0, operator: operators[1] },
      { id: 3, name: 'Montaj HattÄ±', status: 'running', wip: 22, oee: 89, operator: operators[2] },
      { id: 4, name: 'Final Test', status: 'running', wip: 10, oee: 91, operator: operators[3] },
      { id: 5, name: 'Paketleme', status: 'running', wip: 8, oee: 95, operator: operators[4] }
    ];
    const stations = [
      { id: 'ST-101', name: 'Metal Kesim', line: 1, operator: operators[0], machines: [
        { id: 'MK-01', status: 'running', oee: 88 },
        { id: 'MK-02', status: 'running', oee: 91 },
        { id: 'MK-03', status: 'maintenance', oee: 0 }
      ], wip: 8, oee: 85 },
      { id: 'ST-201', name: 'Boya Kabini', line: 2, operator: operators[1], machines: [
        { id: 'BK-01', status: 'running', oee: 82 },
        { id: 'BK-02', status: 'down', oee: 0 }
      ], wip: 12, oee: 72 },
      { id: 'ST-301', name: 'Montaj Ä°stasyonu', line: 3, operator: operators[2], machines: [
        { id: 'MH-01', status: 'running', oee: 90 },
        { id: 'MH-02', status: 'running', oee: 89 }
      ], wip: 15, oee: 89 }
    ];
    const orders = [
      { id: 'TK-001', line: 2, position: 25, status: 'blocked' },
      { id: 'TK-002', line: 3, position: 60, status: 'ok' },
      { id: 'TK-003', line: 1, position: 80, status: 'ok' },
      { id: 'TK-004', line: 4, position: 45, status: 'ok' },
      { id: 'TK-005', line: 5, position: 70, status: 'ok' },
      { id: 'TK-006', line: 3, position: 30, status: 'warning' },
      { id: 'TK-007', line: 1, position: 35, status: 'ok' },
      { id: 'TK-008', line: 2, position: 55, status: 'critical' }
    ];
    
    let speed = 0.25, alertsOn = false;

    function init() {
      updateShift();
      renderLanes();
      renderStations();
      renderTokens();
      initOrderTimelineOnce();
      initFlowKPIOnce();
      initTokenInfoOnce();
      animate();
    }

    function updateShift() {
      const h = new Date().getHours();
      const shift = h >= 7 && h < 15 ? '1. VARDÄ°YA|07:00 - 15:00' : h >= 15 && h < 23 ? '2. VARDÄ°YA|15:00 - 23:00' : '3. VARDÄ°YA|23:00 - 07:00';
      const [name, time] = shift.split('|');
      document.getElementById('shiftBadge').textContent = name;
      document.getElementById('shiftTime').textContent = time;
    }

    function renderLanes() {
      document.getElementById('flowLanes').innerHTML = lines.map(l => `
        <div class="flow-lane" data-line="${l.id}">
          <div class="lane-header">
            <div class="lane-info"><div class="lane-number">${l.id}</div><div class="lane-name">${l.name}</div></div>
            <div class="lane-status"><div class="status-dot ${l.status}"></div><span>${l.status === 'running' ? 'â–¶ Ã‡alÄ±ÅŸÄ±yor' : 'â–  DurmuÅŸ'}</span></div>
            <div class="lane-operator">${ICONS.user} <span class="operator-name">${l.operator}</span></div>
            <div class="lane-metrics"><div class="lane-metric"><strong>${l.wip}</strong> WIP</div><div class="lane-metric"><strong>${l.oee}%</strong> OEE</div></div>
          </div>
          <div class="lane-track"></div>
          <div class="lane-stations">
            ${stations.filter(s => s.line === l.id).map((s, i) => {
              const down = s.machines.some(m => m.status === 'down');
              return `<div class="station-checkpoint ${down ? 'down' : 'active'}" title="${s.name}">${i+1}</div>`;
            }).join('')}
          </div>
        </div>
      `).join('');
    }
    return;

  const html = list.map((st)=>{
    const status = (st.status === 'running') ? 'ok' : (st.status === 'stopped' ? 'down' : (st.status || 'ok'));
    const dot = status==='down' ? '#D51635' : (status==='warn' ? '#f9ba00' : '#0a7a3a');

    const name = st.name || ('Step ' + (st.id||''));
    const meta = 'Step ' + (st.id||'-');
    const op   = st.operator || '-';
    const wip  = (st.wip === 0 || st.wip) ? st.wip : '-';
    const oee  = (typeof st.oee === 'number') ? Math.round(st.oee) : (st.oee || '-');

    return `
      <div class="station-card">
        <div class="st-top">
          <div class="st-title"><span class="st-dot" style="background:${dot}"></span>${name}</div>
          <div class="st-meta">${meta}</div>
        </div>
        <div class="st-body">
          <div class="st-row"><span class="k">Operator</span><span class="v">${op}</span></div>
          <div class="st-row"><span class="k">WIP</span><span class="v">${wip}</span></div>
          <div class="st-row"><span class="k">OEE</span><span class="v">${oee}%</span></div>
        </div>
      </div>`;
  }).join('');

  host.innerHTML = html;
  const ov = host.querySelector('.no-data-overlay');
  if(ov) ov.remove();
        return;
      }

      const html = list.map((st)=>{
        const status = (st.status || 'ok').toLowerCase();
        const dot = status==='down' ? '#D51635' : (status==='warn' ? '#f9ba00' : '#0a7a3a');

        const name = st.name || st.id || 'Station';
        const line = st.line_name || st.line || '';
        const op   = st.operator || '-';
        const wip  = (st.wip === 0 || st.wip) ? st.wip : '-';
        const oee  = (typeof st.oee === 'number') ? Math.round(st.oee) : (st.oee || '-');

        return `
          <div class="station-card">
            <div class="st-top">
              <div class="st-title"><span class="st-dot" style="background:${dot}"></span>${name}</div>
              <div class="st-meta">${line}</div>
            </div>
            <div class="st-body">
              <div class="st-row"><span class="k">Operator</span><span class="v">${op}</span></div>
              <div class="st-row"><span class="k">WIP</span><span class="v">${wip}</span></div>
              <div class="st-row"><span class="k">OEE</span><span class="v">${oee}%</span></div>
            </div>
          </div>`;
      }).join('');

      host.innerHTML = html;
      const ov = host.querySelector('.no-data-overlay');
      if(ov) ov.remove();
    }




    function renderTokens() {
      orders.forEach(o => {
        const lane = document.querySelector(`[data-line="${o.line}"]`);
        if (!lane) return;
        const token = document.createElement('div');
        token.className = `order-token ${o.status}`;
        token.innerHTML = ICONS.washer;
        token.style.left = `calc(260px + ${o.position}%)`;
        token.dataset.id = o.id;
        token.dataset.machine = 'M-'+String(o.line).padStart(2,'0');
        token.dataset.co2 = String(Math.round(((o.status==='critical'?22:18)+(o.position%5))*10)/10);
        const badge = document.createElement('div');
        badge.className = 'token-badge';
        badge.innerHTML = o.status === 'ok' ? ICONS.check : o.status === 'warning' ? ICONS.warn : '!';
        token.appendChild(badge);
        lane.appendChild(token);
      });
    }

    function animate() {
      orders.forEach(o => {
        if (o.status !== 'blocked' && o.status !== 'critical') {
          o.position += 0.05 * speed;
          if (o.position > 95) o.position = 5;
          const el = document.querySelector(`[data-id="${o.id}"]`);
          if (el) el.style.left = `calc(260px + ${o.position}%)`;
        }
      });
      requestAnimationFrame(animate);
    }

    function setSpeed(s) {
      speed = s;
      document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
    }

    function toggleAlerts() {
      alertsOn = !alertsOn;
      document.getElementById('alertToggle').classList.toggle('active', alertsOn);
      if (alertsOn) {
        showAlert('Bildirimler Aktif', 'Kritik durumlar iÃ§in bildirim alacaksÄ±nÄ±z.', 'var(--zero-green)');
        setInterval(() => {
          if (Math.random() > 0.7 && alertsOn) {
            const alerts = [
              ['ðŸ”´ Makine ArÄ±zasÄ±', 'BK-02 kompresÃ¶r arÄ±zasÄ± tespit edildi', 'var(--zero-red)'],
              ['ðŸŸ¡ BakÄ±m UyarÄ±sÄ±', 'MK-03 planlÄ± bakÄ±m baÅŸladÄ±', 'var(--zero-orange)'],
              ['ðŸŸ¢ Hedef AÅŸÄ±ldÄ±', 'Montaj hattÄ± OEE %95 seviyesine ulaÅŸtÄ±', 'var(--zero-green)']
            ];
            const a = alerts[Math.floor(Math.random() * alerts.length)];
            showAlert(a[0], a[1], a[2]);
          }
        }, 15000);
      }
    }

    function showAlert(title, msg, color) {
      const n = document.getElementById('alertNotif');
      n.style.borderLeftColor = color;
      document.getElementById('alertTitle').textContent = title;
      document.getElementById('alertMessage').textContent = msg;
      document.getElementById('alertTime').textContent = new Date().toLocaleTimeString('tr-TR');
      n.classList.add('show');
      setTimeout(() => n.classList.remove('show'), 5000);
    }

    function closeAlert() {
      document.getElementById('alertNotif').classList.remove('show');
    }

    /* PATCH START: Flow Cards + Token Info Fix */
    function initFlowKPIOnce(){ if(window.__FLOW_KPI_INIT__) return; window.__FLOW_KPI_INIT__=true; updateFlowKPI(); if(!window.__FLOW_KPI_LOOP__){ window.__FLOW_KPI_LOOP__ = setInterval(updateFlowKPI, 5000); } }
    function updateFlowKPI(){ try{
      const percEl = document.getElementById('fwPerc');
      const perc = percEl ? parseInt((percEl.textContent||'0').replace(/[^0-9]/g,'')) : 0;
      const co2 = Math.round(((12*0.42)+(perc%5))*10)/10;
      const oeeAvg = stations.length ? Math.round(stations.reduce((x,s)=> x+(s.oee||0),0)/(stations.length||1)) : 90;
      const drift = perc>80 ? 'On Track' : (perc<20 ? 'Late' : 'Stable');
      const coEl=document.getElementById('kpiCO2'); const oeEl=document.getElementById('kpiOEE'); const etEl=document.getElementById('kpiETA');
      if(coEl) coEl.textContent = co2+' kg'; if(oeEl) oeEl.textContent = oeeAvg+' %'; if(etEl) etEl.textContent = drift;
    }catch(e){}
    }
    function initTokenInfoOnce(){ if(window.__TOKEN_INFO_INIT__) return; window.__TOKEN_INFO_INIT__=true; const host=document.getElementById('flowLanes'); if(!host) return;
      host.addEventListener('mouseenter', function(e){
  const t = e.target.closest('.order-token'); if(!t) return;

  // already visible?
  if(t.__chip && document.body.contains(t.__chip)) return;

  const chip = document.createElement('div');
  chip.className = 'token-chip';
  chip.textContent =
    (t.dataset.id || '-') + ' â€¢ ' +
    (t.dataset.machine || '-') + ' â€¢ ' +
    'CO2 ' + (t.dataset.co2 || '-') + 'kg';

  document.body.appendChild(chip);

  const r = t.getBoundingClientRect();
  const x = r.left + (r.width / 2) + 22; // shift right a bit
  const y = r.top - 12;                  // lift a bit

  chip.style.left = x + 'px';
  chip.style.top  = y + 'px';

  t.__chip = chip;
}, true);

host.addEventListener('mouseleave', function(e){
  const t = e.target.closest('.order-token'); if(!t) return;
  const chip = t.__chip;
  if(chip && chip.parentNode) chip.parentNode.removeChild(chip);
  t.__chip = null;
}, true);

host.addEventListener('click', function(e){
  const t = e.target.closest('.order-token'); if(!t) return;
  const payload = {
    id: t.dataset.id || '-',
    machine: t.dataset.machine || '-',
    co2: parseFloat(t.dataset.co2 || '18.4'),
    energy: parseFloat(t.dataset.energy || '12'),
    plan: parseFloat(t.dataset.plan || '60'),
    progress: parseFloat(t.dataset.progress || '50'),
    status: t.dataset.status || 'ok',
    anchor: t
  };
  if(typeof openTokenPopup === 'function') openTokenPopup(payload);
}, true);

document.addEventListener('click', function(e){ const p=document.getElementById('orderPopup'); if(!p) return; if(e.target===p || p.contains(e.target)) return; closeTokenPopup(); }, true);
    function openTokenPopupFlow(info){
  // DEPRECATED: unified popup uses openTokenPopup(payload)
  // Keeping as stub to prevent accidental double-popup wiring.
  try{
    if(typeof openTokenPopup === 'function') return openTokenPopup(info || {});
  }catch(e){}
}
    }
    /* PATCH END: Flow Cards + Token Info Fix */

    /* PATCH START: Full Width Timeline */
    function initOrderTimelineOnce(){ if(window.__FW_TL_INIT__) return; window.__FW_TL_INIT__=true; try{
      var live=document.getElementById('fwLive'), rep=document.getElementById('fwReplay');
      if(live&&rep){
        live.onclick=function(){ this.classList.add('active'); rep.classList.remove('active'); document.getElementById('fwETA').style.opacity='1'; };
        rep.onclick=function(){ this.classList.add('active'); live.classList.remove('active'); document.getElementById('fwETA').style.opacity='0.85'; };
      }
      renderOrderTimeline();
      if(!window.__ORDER_LOOP__){ window.__ORDER_LOOP__ = setInterval(renderOrderTimeline, 4000); }
    }catch(e){}
    }
    function makeDemoOrdersQueue(){ const now=Date.now(); const mk=(id,len)=>({id,model:'Industrial Washer',machine_id:'WM-'+String(id).slice(-3),plan_min:len,progress:Math.round(Math.random()*40+20),status:'ok',co2_unit: Math.round((18 + 12*0.42)*10)/10, energy_kwh:12, water_l:28, updated_ts:new Date(now).toISOString()}); return [mk('SO-10492',120), mk('SO-10493',90), mk('SO-10494',110), mk('SO-10495',80)]; }
    function renderOrderTimeline(){ (async()=>{
      let orders=[];
      if(typeof getOrdersV1Safe==='function'){ try{ const r=await getOrdersV1Safe(); orders=(r.orders||[]); }catch(e){ orders=[]; } }
      if(!orders.length){ const d = makeDemoOrdersQueue(); orders = d.map((o,i)=> ({ order_id:o.id, plan_min:o.plan_min, progress:o.progress, status: i===0?'ok':(i===1?'warning':'critical'), energy_kwh:o.energy_kwh, co2e_kg:o.co2_unit, machine_id:o.machine_id, updated_ts:o.updated_ts })); }
      const active = orders[0] || { order_id:'-', plan_min:60, progress:0, status:'ok', updated_ts:new Date().toISOString(), energy_kwh:12, co2e_kg:18.4, machine_id:'-' };
      const queue = orders.slice(1);
      const etaMin = Math.max(0, Math.round(((100-active.progress)/100)*active.plan_min));
      var elOrder=document.getElementById('fwOrder'); if(elOrder) elOrder.textContent = 'Order ' + (active.order_id||'-');
      var elPerc=document.getElementById('fwPerc'); if(elPerc) elPerc.textContent = Math.min(100,Math.round(active.progress)) + '%';
      var elETA=document.getElementById('fwETA'); if(elETA) elETA.textContent = 'ETA: ' + etaMin + 'm';
      var elQueueLbl=document.getElementById('fwQueueLbl'); if(elQueueLbl) elQueueLbl.textContent = 'Queue: ' + queue.length;
      var elSync=document.getElementById('fwSync'); if(elSync) elSync.textContent = 'Last Sync: ' + new Date().toLocaleTimeString('tr-TR');
      var prog=document.getElementById('fwProg'), now=document.getElementById('fwNow');
      var pct=Math.min(100,Math.round(active.progress)); if(prog) prog.style.width=pct+'%'; if(now) now.style.left=pct+'%';
      var qHost=document.getElementById('fwQueue'); if(qHost){ qHost.innerHTML='';
        queue.slice(0,3).forEach(function(o){ var t=document.createElement('span'); t.className='fw-q-token'; t.textContent=o.order_id||'-'; t.onclick=function(){ if(typeof openTokenPopup==='function'){ openTokenPopup({ id:o.order_id, machine:o.machine_id, co2:o.co2e_kg, energy:o.energy_kwh, plan:o.plan_min, progress:o.progress, status:o.status }); } }; qHost.appendChild(t); });
        if(queue.length>3){ var more=document.createElement('span'); more.className='fw-q-more'; more.textContent='â€¦'; qHost.appendChild(more); }
      }
    })(); }
    if(typeof openTokenPopup!== 'function'){
            function openTokenPopup(t){
        try{ closeTokenPopup(); }catch(e){}

        const p=document.createElement('div');
        p.className='order-popup';
        p.id='orderPopup';

        const co2 = Math.round((((t&&t.co2)!=null?t.co2:18.4))*10)/10;
        const energy = (t&&t.energy)!=null ? t.energy : 12;
        const water  = (t&&t.water)!=null ? t.water : 28;
        const progress = (t&&t.progress)!=null ? t.progress : 50;
        const plan = (t&&t.plan)!=null ? t.plan : 60;
        const etaMin = Math.max(0, Math.round(((100 - progress)/100) * plan));

        const quick = `
          <div class="op-body">
            <div style="font-size:1.1rem;font-weight:800;color:#02154e">Order ${(t&&t.id)||'-'}</div>
            <div style="margin-top:.25rem;color:#333">Step/Station: ${(t&&t.machine)||'-'}</div>
            <div style="margin-top:.45rem;color:#333">COâ‚‚e / Unit: <strong>${co2} kg</strong></div>
            <div style="margin-top:.35rem;color:#333">Energy: <strong>${energy}</strong> kWh â€¢ Water: <strong>${water}</strong> L</div>
            <div style="margin-top:.35rem;color:#333">ETA: ~ <strong>${etaMin}m</strong> â€¢ Status: ${(t&&t.status)||'-'}</div>
          </div>
        `;

        const details = `
          <div class="op-body">
            <div>Quality (FPY): ~</div>
            <div>Downtime: -</div>
            <div>Scrap/Repair: -</div>
            <div style="margin-top:.4rem;color:#666;font-size:.9rem">(*demo values)</div>
          </div>
        `;

        p.innerHTML = `
          <div class="op-head">
            <div>Token Info</div>
            <button onclick="closeTokenPopup()" class="op-tab">X</button>
          </div>
          <div class="op-tabs">
            <button id="tabQ" class="op-tab active">Quick</button>
            <button id="tabD" class="op-tab">Details</button>
          </div>
          <div id="opCont">${quick}</div>
        `;

        document.body.appendChild(p);

        const tabQ = document.getElementById('tabQ');
        const tabD = document.getElementById('tabD');
        const cont = document.getElementById('opCont');
        if(tabQ && tabD && cont){
          tabQ.onclick = function(){ tabQ.classList.add('active'); tabD.classList.remove('active'); cont.innerHTML = quick; };
          tabD.onclick = function(){ tabD.classList.add('active'); tabQ.classList.remove('active'); cont.innerHTML = details; };
        }

        // anchor-aware + overflow->center
        try{
          const a = t && t.anchor;
          if(a && a.getBoundingClientRect){
            const r = a.getBoundingClientRect();
            const w = 340, h = 220;
            const left = r.left + window.scrollX + 12;
            const top  = r.bottom + window.scrollY + 10;
            const overflow = (r.left + w > window.innerWidth) || (r.bottom + h > window.innerHeight);
            if(overflow){
              p.classList.add('center');
              p.style.left='';
              p.style.top='';
            }else{
              p.style.left = left + 'px';
              p.style.top  = top + 'px';
            }
          }else{
            p.classList.add('center');
          }
        }catch(e){
          p.classList.add('center');
        }

        p.addEventListener('click',(e)=>{ if(e.target===p) closeTokenPopup(); });
      }

      function closeTokenPopup(){
        const p=document.getElementById('orderPopup');
        if(p) p.remove();
      }}
    /* PATCH END: Full Width Timeline */

    init();
    setInterval(updateShift, 60000);
  </script>

</body>
</html>
