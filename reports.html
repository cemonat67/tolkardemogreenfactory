<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zero@Factory — Raporlar</title>
  <link rel="icon" href="factory-logo 2.svg">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--navy:#02154e;--orange:#f9ba00;--green:#005530;--red:#D51635;--bg:#ffffff;--fg:#1a1a1a;--muted:#666;--border:#e0e0e0}
    [data-theme="dark"]{--bg:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--border:#334155}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--fg);line-height:1.6}
    .bar{height:4px;background:linear-gradient(90deg,var(--green),var(--red),var(--navy),var(--orange))}
    header{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;border-bottom:1px solid var(--border)}
    .title{font-size:1.25rem;color:var(--navy)}
    .container{max-width:1200px;margin:0 auto;padding:2rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}
    .card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:1rem}
    .btn{padding:.5rem 1rem;background:var(--navy);color:#fff;border:none;border-radius:6px;cursor:pointer}
    .btn:hover{background:var(--orange);color:var(--navy)}
    .toolbar{display:flex;gap:.5rem;align-items:center}
    .kpi{font-weight:600;color:var(--navy)}
    .toast{position:fixed;bottom:16px;right:16px;background:#111;color:#fff;padding:.75rem 1rem;border-radius:8px;opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="bar"></div>
  <header>
    <div class="title">Zero@Factory — Raporlar</div>
    <div class="toolbar">
      <button class="btn" onclick="location.href='dashboard.html'">Dashboard</button>
      <button class="btn" id="btn-theme">Dark Mode</button>
      <button class="btn" id="btn-export">Olaylar CSV</button>
      <button class="btn" id="btn-telemetry">Telemetri CSV</button>
      <button class="btn" id="btn-pdf">PDF</button>
    </div>
  </header>
  <main class="container">
    <div class="card" style="margin-bottom:1rem;display:flex;gap:.5rem;align-items:center">
      <span>Başlangıç:</span>
      <input type="datetime-local" id="start">
      <span>Bitiş:</span>
      <input type="datetime-local" id="end">
      <button class="btn" id="btn-apply">Uygula</button>
    </div>
    <div class="grid" id="kpi">
      <div class="card"><div class="kpi">İstasyon Sayısı</div><div id="kpi-stations">-</div></div>
      <div class="card"><div class="kpi">Bottleneck</div><div id="kpi-bottlenecks">-</div></div>
      <div class="card"><div class="kpi">WIP Toplam</div><div id="kpi-wip">-</div></div>
      <div class="card"><div class="kpi">CT Ortalama</div><div id="kpi-ct">-</div></div>
      <div class="card"><div class="kpi">FPY Ortalama</div><div id="kpi-fpy">-</div></div>
      <div class="card"><div class="kpi">OEE Ortalama</div><div id="kpi-oee">-</div></div>
      <div class="card"><div class="kpi">Son 24s Olay</div><div id="kpi-ev">-</div></div>
    </div>
    <div class="grid" style="margin-top:1rem">
      <div class="card" style="grid-column:1/-1">
        <canvas id="chartSummary" height="160"></canvas>
      </div>
    </div>
  </main>
  <div class="toast" id="toast"></div>
  <script>
    window.__API_BASE__ = (location.hostname==='localhost'||location.hostname==='127.0.0.1') ? 'http://127.0.0.1:5000' : location.origin;
  </script>
  <script src="assets/js/auth-wrapper.js"></script>
  <script>
    if(!AUTH.isLoggedIn()) location.href='login.html';
    const toastEl=document.getElementById('toast');
    function toast(t){ toastEl.textContent=t; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),2000); }
    document.getElementById('btn-theme').onclick=()=>{ const d=document.documentElement; const dark=d.getAttribute('data-theme')==='dark'; d.setAttribute('data-theme', dark?'light':'dark'); toast(dark?'Açık tema':'Koyu tema'); };
    document.getElementById('btn-export').onclick=async()=>{
      try{
        const t = AUTH.token();
        const res = await fetch((window.__API_BASE__||'') + '/api/export/events.csv', { headers: { 'Authorization': 'Bearer '+t }});
        if(!res.ok) throw new Error('Export başarısız');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='events.csv'; a.click(); URL.revokeObjectURL(url);
        toast('CSV indirildi');
      }catch(e){ toast(e.message||'Hata'); }
    };
    document.getElementById('btn-telemetry').onclick=async()=>{
      try{
        const t = AUTH.token();
        const res = await fetch((window.__API_BASE__||'') + '/api/export/telemetry.csv', { headers: { 'Authorization': 'Bearer '+t }});
        if(!res.ok) throw new Error('Export başarısız');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='telemetry.csv'; a.click(); URL.revokeObjectURL(url);
        toast('Telemetri CSV indirildi');
      }catch(e){ toast(e.message||'Hata'); }
    };
    document.getElementById('btn-pdf').onclick=()=>{ window.print(); };
    let chart;
    async function load(){
      try{
        const s = document.getElementById('start').value;
        const e = document.getElementById('end').value;
        const qs = (s||e) ? ('?'+new URLSearchParams({start:s?new Date(s).toISOString():'', end:e?new Date(e).toISOString():''}).toString()) : '';
        const r = await AUTH.get('/api/v1/lines');
        document.getElementById('kpi-stations').textContent=r.summary.stations;
        document.getElementById('kpi-bottlenecks').textContent=r.summary.bottlenecks;
        document.getElementById('kpi-wip').textContent=r.kpi.wip_sum;
        document.getElementById('kpi-ct').textContent=r.kpi.ct_avg;
        document.getElementById('kpi-fpy').textContent=r.kpi.fpy_avg+'%';
        document.getElementById('kpi-oee').textContent=r.kpi.oee_avg+'%';
        document.getElementById('kpi-ev').textContent=r.events_last_24h;
        const ctx=document.getElementById('chartSummary').getContext('2d');
        if(chart) chart.destroy();
        chart=new Chart(ctx,{type:'bar',data:{labels:['WIP','CT','FPY','OEE'],datasets:[{label:'Özet',data:[r.kpi.wip_sum,r.kpi.ct_avg,r.kpi.fpy_avg,r.kpi.oee_avg],backgroundColor:['#005530','#02154e','#f9ba00','#D51635']}]},options:{responsive:true}});
      }catch(e){ toast(e.message||'Veri yüklenemedi'); }
    }
    document.getElementById('btn-apply').onclick=load;
    load();
  </script>
</body>
</html>
