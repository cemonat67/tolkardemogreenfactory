<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zero@Factory - TOLKAR — MES</title>
  <style>
    :root {
      --zero-navy: #02154e;
      --zero-orange: #f9ba00;
      --zero-green: #005530;
      --zero-red: #D51635;
      --zero-white: #ffffff;
      --zero-black: #1a1a1a;
      --zero-gray-dark: #666;
      --zero-gray-light: #e0e0e0;
      --zero-gray-bg: #fafafa;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: var(--zero-white);
      color: var(--zero-black);
      line-height: 1.6;
    }

    .zero-color-bar {
      height: 4px;
      width: 100%;
      background: linear-gradient(90deg,
        var(--zero-green) 0%, var(--zero-green) 25%,
        var(--zero-red) 25%, var(--zero-red) 50%,
        var(--zero-navy) 50%, var(--zero-navy) 75%,
        var(--zero-orange) 75%, var(--zero-orange) 100%);
    }

    .app-header {
      background: var(--zero-white);
      color: var(--zero-navy);
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-bottom: 1px solid var(--zero-gray-light);
      position: relative;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }

    .title {
      font-size: 1.8rem;
      font-weight: 300;
      color: var(--zero-navy);
    }

    .title-at { color: var(--zero-orange); }

    .subtitle {
      margin-top: 0.5rem;
      font-size: 0.95rem;
      color: #666;
      font-weight: 400;
    }

    .facility-pill {
      display: inline-block;
      background: var(--zero-green);
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .health-bar {
      position: absolute;
      right: 2rem;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .pill {
      padding: 0.35rem 0.7rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--zero-green);
      color: #fff;
      border: none;
      white-space: nowrap;
    }

    .pill.offline { background: var(--zero-red); }
    .pill.neutral { background: var(--zero-navy); }
    .pill.orange { background: var(--zero-orange); color:#000; }

    .back-btn {
      cursor: pointer;
      border: none;
      background: var(--zero-navy);
      color: #fff;
      border-radius: 8px;
      padding: 0.45rem 0.8rem;
      font-weight: 700;
    }
    .back-btn:hover { background: var(--zero-orange); color: var(--zero-navy); }

    /* CO2 STRIP */
    .co2-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin: 1rem 0;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      padding: 0 2rem;
    }

    .co2-item {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 1rem;
    }

    .co2-title {
      font-size: 0.8rem;
      color: var(--zero-navy);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .co2-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--zero-navy);
      line-height: 1;
    }

    .co2-sub {
      font-size: 0.75rem;
      color: #666;
      margin-top: 0.5rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem 2rem;
    }

    .card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-weight: 700;
      color: var(--zero-navy);
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
    }

    /* MES TABLE */
    .mes-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .mes-table th,
    .mes-table td {
      padding: 0.75rem;
      border: 1px solid #e0e0e0;
      text-align: left;
    }

    .mes-table th {
      background: var(--zero-gray-bg);
      font-weight: 600;
      color: var(--zero-navy);
    }

    .mes-table tr:hover { background: #f9fafb; }
    .mes-table tr.active { background: rgba(0, 85, 48, 0.05); }

    .status-badge {
      display: inline-block;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.active {
      background: rgba(0, 85, 48, 0.1);
      color: var(--zero-green);
    }

    .status-badge.pending {
      background: rgba(249, 186, 0, 0.1);
      color: #a86700;
    }

    .status-badge.completed {
      background: rgba(2, 21, 78, 0.1);
      color: var(--zero-navy);
    }

    /* TIMELINE TOKENS */
    .mes-timeline {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      margin-bottom: 1.5rem;
      padding: 0.5rem 0;
    }

    .mes-token {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #f5f7fa;
      color: var(--zero-navy);
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .mes-token:hover,
    .mes-token.active {
      background: var(--zero-navy);
      color: #fff;
      transform: scale(1.1);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 0.25rem;
    }

    .progress-fill {
      height: 100%;
      background: var(--zero-green);
      transition: width 0.3s ease;
    }

    .progress-fill.warning { background: var(--zero-orange); }
    .progress-fill.danger { background: var(--zero-red); }

    .small-text {
      font-size: 0.75rem;
      color: #666;
    }

    .badge-ok { color: var(--zero-green); font-weight: 600; }
    .badge-watch { color: var(--zero-orange); font-weight: 600; }
    .badge-action { color: var(--zero-red); font-weight: 600; }

    /* V3: Status proof + offline banner */
    .status-proof{position:absolute;right:2rem;top:.75rem;display:flex;gap:.5rem;align-items:center;font-size:.82rem;color:#02154e}
    .status-pill{padding:.3rem .6rem;border-radius:10px;font-weight:700}
    .status-pill.live{background:var(--zero-green);color:#fff}
    .status-pill.degraded{background:var(--zero-orange);color:#000}
    .status-pill.offline{background:var(--zero-red);color:#fff}
    .offline-banner{display:none;margin:0 auto 1rem;background:rgba(249,186,0,.12);border:1px solid rgba(249,186,0,.35);color:#5c4400;border-radius:10px;max-width:1200px;padding:.6rem .9rem}
    .offline-banner.visible{display:block}

    /* V3: Timeline tokens (separate host) */
    .timeline-tokens{display:flex;gap:.5rem;overflow-x:auto;margin:.75rem auto;max-width:1200px;padding:.25rem 2rem}
    .token{display:inline-flex;align-items:center;justify-content:center;min-width:45px;height:45px;border-radius:50%;background:#f5f7fa;color:var(--zero-navy);font-size:.75rem;font-weight:600;border:1px solid #e0e0e0;cursor:pointer;transition:.2s;flex:0 0 auto}
    .token.active{background:var(--zero-navy);color:#fff;transform:scale(1.06)}

    /* V3: Orders meta */
    .orders-meta{max-width:1200px;margin:0 auto .5rem;color:#02154e;padding:0 2rem;font-size:.85rem}

    /* V3: Drawer */
    .order-drawer{position:fixed;right:-420px;top:0;height:100vh;width:420px;background:#fff;border-left:1px solid #e0e0e0;box-shadow:-8px 0 20px rgba(0,0,0,.12);transition:right .25s;z-index:1000}
    .order-drawer.open{right:0}
    .order-drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.12);opacity:0;pointer-events:none;transition:opacity .2s;z-index:999}
    .order-drawer-overlay.open{opacity:1;pointer-events:auto}
    .drawer-header{padding:12px;border-bottom:1px solid #e0e0e0}
    .drawer-close{float:right;border:none;background:#02154e;color:#fff;border-radius:6px;padding:.3rem .6rem;font-weight:700;cursor:pointer}
    .drawer-title{font-weight:800;color:#02154e}
    .drawer-pills{margin-top:.4rem;display:flex;gap:.4rem;flex-wrap:wrap}
    .drawer-proof{margin-top:.4rem;color:#666;font-size:.82rem}
    .drawer-content{padding:10px;overflow:auto;height:calc(100vh - 120px)}
    .flow-step{display:flex;gap:.5rem;align-items:center;margin:.25rem 0}
    .step-indicator{width:12px;height:12px;border-radius:50%;background:#e0e0e0}
    .step-indicator.live{background:var(--zero-green)}
    .kpi-mini{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:.6rem}
    .event-item{padding:.35rem .5rem;border:1px solid #e0e0e0;border-radius:8px;margin:.25rem 0;color:#333}
    .drawer-footer{position:sticky;bottom:0;background:#fff;border-top:1px solid #e0e0e0;padding:10px}
    .drawer-btn{border:none;background:#02154e;color:#fff;border-radius:8px;padding:.4rem .8rem;font-weight:700;cursor:pointer}

    @media (max-width: 768px) {
      .co2-strip { grid-template-columns: repeat(2, 1fr); }
      .mes-table { font-size: 0.75rem; }
      .mes-table th, .mes-table td { padding: 0.5rem 0.25rem; }
      .health-bar { right: 1rem; }
    }
  </style>
</head>

<body>
  <div class="zero-color-bar"></div>

  <header class="app-header">
    <div class="header-content">
      <div class="title">Zero<span class="title-at">@</span>Green Factory</div>
      <div class="subtitle">Sürdürülebilir Üretim Kontrol Merkezi — MES</div>
      <div class="facility-pill">Facility: TOLKAR</div>
    </div>

    <div class="health-bar">
      <button class="back-btn" id="backBtn">← Dashboard</button>
      <span class="pill" id="healthStatus">ONLINE</span>
      <span class="pill neutral">ML READY</span>
    </div>
  </header>
  <div class="offline-banner" id="offlineBanner">Offline mod — Son bilinen veriyi gösteriyoruz</div>

  <!-- CO2 STRIP -->
  <div class="co2-strip" id="co2Strip">
    <div class="co2-item">
      <div class="co2-title">CO₂e Bugün (kg) <span class="pill" id="co2TodayPill">OK</span></div>
      <div class="co2-value" id="co2TodayVal">980</div>
      <div class="co2-sub">vs dün: +45</div>
    </div>
    <div class="co2-item">
      <div class="co2-title">CO₂e / Birim (kg) <span class="pill" id="co2UnitPill">OK</span></div>
      <div class="co2-value" id="co2UnitVal">21.8</div>
      <div class="co2-sub">hedef: 20</div>
    </div>
    <div class="co2-item">
      <div class="co2-title">Enerji (kWh)</div>
      <div class="co2-value" id="energyVal">1240</div>
      <div class="co2-sub">intensity</div>
    </div>
    <div class="co2-item">
      <div class="co2-title">Su (L) <span class="pill orange" style="margin-left: 6px;">LIVE</span></div>
      <div class="co2-value" id="waterVal">2960</div>
      <div class="co2-sub">intensity</div>
    </div>
  </div>
  <div class="order-drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
  <div class="order-drawer" id="orderDrawer">
    <div class="drawer-header">
      <button class="drawer-close" onclick="closeDrawer()">×</button>
      <div class="drawer-title" id="drawerTitle"></div>
      <div class="drawer-pills" id="drawerPills"></div>
      <div class="drawer-proof" id="drawerProof"></div>
    </div>
    <div class="drawer-content" id="drawerContent"></div>
    <div class="drawer-footer"><button class="drawer-btn" onclick="closeDrawer()">Kapat</button></div>
  </div>

  <div class="orders-meta" id="ordersMeta"></div>
  <div class="container">
    <!-- MES -->
    <div class="card">
      <div class="card-title">MES — Sipariş Zaman Çizelgesi</div>
      <div class="mes-timeline" id="mesTimeline">
        <div class="mes-token active" onclick="highlightOrder(this, 'ORD-1001')">#1</div>
        <div class="mes-token" onclick="highlightOrder(this, 'ORD-1002')">#2</div>
        <div class="mes-token" onclick="highlightOrder(this, 'ORD-1003')">#3</div>
        <div class="mes-token" onclick="highlightOrder(this, 'ORD-1004')">#4</div>
        <div class="mes-token" onclick="highlightOrder(this, 'ORD-1005')">#5</div>
        <div class="mes-token" onclick="highlightOrder(this, 'ORD-1006')">#6</div>
        <div class="mes-token" onclick="highlightOrder(this, 'ORD-1007')">#7</div>
        <div class="mes-token" onclick="highlightOrder(this, 'ORD-1008')">#8</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Aktif Siparişler</div>
      <table class="mes-table orders-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Hat</th>
            <th>İstasyon</th>
            <th>Durum</th>
            <th>İlerleme</th>
            <th>ETA</th>
            <th>Enerji (kWh)</th>
            <th>CO₂e (kg)</th>
            <th>Risk</th>
          </tr>
        </thead>
        <tbody id="ordersTable">
          <tr class="active">
            <td><strong>ORD-1001</strong></td>
            <td>Hat-1</td>
            <td>S1</td>
            <td><span class="status-badge active">AKTİF</span></td>
            <td>
              <div class="progress-bar"><div class="progress-fill" style="width: 65%;"></div></div>
              <span class="small-text">65%</span>
            </td>
            <td>+45m</td>
            <td>12.4</td>
            <td><strong>18.2</strong></td>
            <td><span class="badge-ok">OK</span></td>
          </tr>
          <tr class="active">
            <td><strong>ORD-1002</strong></td>
            <td>Hat-2</td>
            <td>S2</td>
            <td><span class="status-badge active">AKTİF</span></td>
            <td>
              <div class="progress-bar"><div class="progress-fill warning" style="width: 42%;"></div></div>
              <span class="small-text">42%</span>
            </td>
            <td>+90m</td>
            <td>9.8</td>
            <td><strong>22.6</strong></td>
            <td><span class="badge-watch">WATCH</span></td>
          </tr>
          <tr>
            <td><strong>ORD-1003</strong></td>
            <td>Hat-3</td>
            <td>S3</td>
            <td><span class="status-badge pending">BEKLEMEDE</span></td>
            <td>
              <div class="progress-bar"><div class="progress-fill" style="width: 0%;"></div></div>
              <span class="small-text">0%</span>
            </td>
            <td>+2h</td>
            <td>0.0</td>
            <td><strong>0.0</strong></td>
            <td><span class="badge-ok">OK</span></td>
          </tr>
          <tr>
            <td><strong>ORD-1004</strong></td>
            <td>Hat-4</td>
            <td>S1</td>
            <td><span class="status-badge completed">TAM</span></td>
            <td>
              <div class="progress-bar"><div class="progress-fill" style="width: 100%;"></div></div>
              <span class="small-text">100%</span>
            </td>
            <td>Done</td>
            <td>15.2</td>
            <td><strong>25.4</strong></td>
            <td><span class="badge-ok">OK</span></td>
          </tr>
          <tr>
            <td><strong>ORD-1005</strong></td>
            <td>Hat-1</td>
            <td>S2</td>
            <td><span class="status-badge active">AKTİF</span></td>
            <td>
              <div class="progress-bar"><div class="progress-fill" style="width: 28%;"></div></div>
              <span class="small-text">28%</span>
            </td>
            <td>+2.5h</td>
            <td>8.6</td>
            <td><strong>19.8</strong></td>
            <td><span class="badge-ok">OK</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    (function(){
      var backBtn=document.getElementById('backBtn');
      if(backBtn){ backBtn.addEventListener('click', function(){ var qs=window.location.search||''; window.location.href='dashboard.html'+qs; }); }

      const API_TIMEOUT_MS=3500; const CACHE_KEY='tolkar_last_snapshot_v1'; const CACHE_TS_KEY='tolkar_last_snapshot_ts'; const REALISTIC_COUNT=11;
      let CONN_STATE={ state:'loading', lastSyncTS:null, latencyMS:null, mode:'demo', source:'/api/mes/snapshot', snapshot:null };

      function setConnState(state, meta){ CONN_STATE.state=state; if(meta){ if(meta.lastSyncTS) CONN_STATE.lastSyncTS=meta.lastSyncTS; if(typeof meta.latencyMS==='number') CONN_STATE.latencyMS=meta.latencyMS; if(meta.mode) CONN_STATE.mode=meta.mode; if(meta.source) CONN_STATE.source=meta.source; } updateStatusProof(); updateOfflineBanner(); }
      function updateStatusProof(){ var proofHealth=document.getElementById('proofHealth'); var proofSync=document.getElementById('proofSync'); var proofLatency=document.getElementById('proofLatency'); var proofMode=document.getElementById('proofMode'); var proofSource=document.getElementById('proofSource'); var state=CONN_STATE.state; if(proofHealth){ proofHealth.className='status-pill '+(state==='live'?'live':(state==='degraded'?'degraded':'offline')); proofHealth.textContent= state==='live'?'LIVE': (state==='degraded'?'DEGRADED':'OFFLINE'); } if(proofSync){ var d=CONN_STATE.lastSyncTS? new Date(CONN_STATE.lastSyncTS): null; proofSync.textContent= d? String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0') : '--:--'; } if(proofLatency) proofLatency.textContent=(CONN_STATE.latencyMS||0)+'ms'; if(proofMode) proofMode.textContent= (CONN_STATE.mode||'demo').toUpperCase(); if(proofSource) proofSource.textContent= CONN_STATE.source||''; }
      function updateOfflineBanner(){ var banner=document.getElementById('offlineBanner'); if(!banner) return; banner.className= 'offline-banner'+(CONN_STATE.state==='offline'?' visible':''); }

      function timeoutFetch(url, ms){ return Promise.race([ fetch(url,{headers:{'Accept':'application/json','Cache-Control':'no-store'}}), new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms)) ]); }
      function normalizeSnapshot(raw){ var s=raw||{}; s.meta=s.meta||{}; s.kpis=s.kpis||{}; s.orders=Array.isArray(s.orders)?s.orders:[]; s.timeline=s.timeline||{}; s.trends=s.trends||{}; return s; }
      function expandOrdersToRealistic(orders){ var out=orders.slice(); var seed=(CONN_STATE.lastSyncTS||Date.now())%100000; function rnd(i,min,max){ var x=(seed*(i+3)%9973); return min + (x%(max-min)); } while(out.length<REALISTIC_COUNT){ var idx=out.length+1; out.push({ order_id:'ORD-'+(1000+idx), line:'Hat-'+((idx%4)+1), station:'S'+((idx%3)+1), status: idx%5===0?'TAM':(idx%3===0?'BEKLEMEDE':'AKTIF'), progress_pct: rnd(idx,10,95), eta_minutes: rnd(idx,10,180), energy_kwh: (rnd(idx,5,20)/1), co2e_kg: (rnd(idx,15,28)/1), risk: (idx%4===0?'WATCH':(idx%6===0?'ACTION':'OK')) }); } return out; }

      function renderTimeline(orders){ var tl=document.getElementById('mesTimeline'); if(tl){ tl.innerHTML=''; orders.forEach(function(o,i){ var d=document.createElement('div'); d.className='mes-token'+(i===0?' active':''); d.textContent='#'+(i+1); d.onclick=function(){ selectOrder(o.order_id); }; tl.appendChild(d); }); } }
      function renderOrders(orders){ var meta=document.getElementById('ordersMeta'); if(meta){ var shown=orders.filter(o=>o.status!=='TAM').length; var done=orders.filter(o=>o.status==='TAM').length; var queue=orders.length-shown; meta.textContent='Gösterilen: '+shown+' • Kuyruk: '+queue+' • Tamamlanan: '+done; }
        var tbody=document.getElementById('ordersTable'); if(!tbody) return; tbody.innerHTML=''; orders.forEach(function(o,i){ var tr=document.createElement('tr'); if(i===0) tr.className='active'; tr.onclick=function(){ selectOrder(o.order_id); };
          var riskClass= o.risk==='WATCH'?'badge-watch':(o.risk==='ACTION'?'badge-action':'badge-ok');
          var statusClass= o.status==='AKTIF'?'active':(o.status==='BEKLEMEDE'?'pending':'completed');
          tr.innerHTML='<td><strong>'+o.order_id+'</strong></td><td>'+o.line+'</td><td>'+o.station+'</td><td><span class="status-badge '+statusClass+'">'+o.status+'</span></td><td><div class="progress-bar"><div class="progress-fill '+(o.risk==='WATCH'?'warning':(o.risk==='ACTION'?'danger':''))+'" style="width: '+(o.progress_pct||0)+'%;"></div></div><span class="small-text">'+(o.progress_pct||0)+'%</span></td><td>'+(o.eta_minutes!=null?('+'+o.eta_minutes+'m'):'')+'</td><td>'+(o.energy_kwh||0)+'</td><td><strong>'+(o.co2e_kg||0)+'</strong></td><td><span class="'+riskClass+'">'+(o.risk||'OK')+'</span></td>';
          tbody.appendChild(tr);
        }); }

      function generateOrderDetails(order){ var idNum=parseInt(String(order.order_id).replace(/\D/g,''),10)||0; function n(min,max){ var x=(idNum*37)%997; return min + (x%(max-min)); } var flow=[{name:'Metal & Şase',state: order.status==='TAM'?'done':(order.progress_pct>10?'live':'pending')},{name:'Boya',state: order.progress_pct>30?'live':'pending'},{name:'Montaj',state: order.progress_pct>60?'live':'pending'},{name:'Final Test',state: order.progress_pct>85?'live':'pending'},{name:'Paket',state: order.status==='TAM'?'done':'pending'}]; var events=[]; for(var i=0;i<8;i++){ events.push({ts: new Date((CONN_STATE.lastSyncTS||Date.now())-i*600000).toLocaleTimeString(), msg:'Olay #'+(i+1)+' • Order '+order.order_id}); } return { flow:flow, kpis:{co2:order.co2e_kg,energy:order.energy_kwh,water:n(100,400),fpy:n(90,99)}, events:events, pills:[{t:'Status',v:order.status},{t:'Risk',v:order.risk},{t:'Progress',v:(order.progress_pct||0)+'%'}] }; }
      function openDrawer(orderId){ var o=(CONN_STATE.snapshot.orders||[]).find(x=>x.order_id===orderId); if(!o) return; var d=generateOrderDetails(o); var drawer=document.getElementById('orderDrawer'); var overlay=document.getElementById('drawerOverlay'); var title=document.getElementById('drawerTitle'); var pills=document.getElementById('drawerPills'); var proof=document.getElementById('drawerProof'); var content=document.getElementById('drawerContent'); if(title) title.textContent=o.order_id+' — '+o.line+' / '+o.station; if(pills){ pills.innerHTML=''; d.pills.forEach(function(p){ var el=document.createElement('span'); el.className='pill'; el.textContent=p.t+': '+p.v; pills.appendChild(el); }); } if(proof){ var dts=CONN_STATE.lastSyncTS? new Date(CONN_STATE.lastSyncTS): null; proof.textContent='Sync '+(dts? dts.toLocaleTimeString(): '--:--')+' • Source '+(CONN_STATE.source||'')+' • '+(CONN_STATE.latencyMS||0)+'ms'; }
        if(content){ content.innerHTML=''; var flowHost=document.createElement('div'); d.flow.forEach(function(s){ var row=document.createElement('div'); row.className='flow-step'; var dot=document.createElement('span'); dot.className='step-indicator '+(s.state==='live'?'live':''); row.appendChild(dot); var name=document.createElement('span'); name.textContent=s.name; row.appendChild(name); flowHost.appendChild(row); }); content.appendChild(flowHost);
          var kpi=document.createElement('div'); kpi.className='kpi-mini'; kpi.innerHTML='<div class="card"><div>CO₂</div><div><strong>'+d.kpis.co2+'</strong></div></div><div class="card"><div>Enerji</div><div><strong>'+d.kpis.energy+'</strong></div></div><div class="card"><div>Su</div><div><strong>'+d.kpis.water+'</strong></div></div><div class="card"><div>FPY</div><div><strong>'+d.kpis.fpy+'%</strong></div></div>'; content.appendChild(kpi);
          d.events.forEach(function(ev){ var e=document.createElement('div'); e.className='event-item'; e.textContent=ev.ts+' — '+ev.msg; content.appendChild(e); }); }
        if(drawer) drawer.classList.add('open'); if(overlay) overlay.classList.add('open'); document.addEventListener('keydown', escClose);
      }
      function escClose(e){ if(e.key==='Escape') closeDrawer(); }
      function closeDrawer(){ var drawer=document.getElementById('orderDrawer'); var overlay=document.getElementById('drawerOverlay'); if(drawer) drawer.classList.remove('open'); if(overlay) overlay.classList.remove('open'); document.removeEventListener('keydown', escClose); }
      // expose close function for inline onclick handlers
      window.closeDrawer = closeDrawer;
      function selectOrder(orderId){ CONN_STATE.snapshot.timeline.selected_order_id=orderId; renderTimeline(CONN_STATE.snapshot.orders||[]); openDrawer(orderId); }

      function fetchSnapshot(){ var start=Date.now(); return timeoutFetch('/api/mes/snapshot?ts='+Date.now(), API_TIMEOUT_MS).then(function(r){ return r.json().then(function(j){ var lat=Date.now()-start; var s=normalizeSnapshot(j); try{ localStorage.setItem(CACHE_KEY, JSON.stringify(s)); localStorage.setItem(CACHE_TS_KEY, String(Date.now())); }catch(e){} CONN_STATE.snapshot=s; setConnState('live',{ lastSyncTS:Date.now(), latencyMS:lat, mode:'live' }); return s; }); }); }
      function loadCachedSnapshot(){ try{ var c=localStorage.getItem(CACHE_KEY); if(!c) return null; var s=normalizeSnapshot(JSON.parse(c)); CONN_STATE.snapshot=s; setConnState('offline',{ lastSyncTS: Number(localStorage.getItem(CACHE_TS_KEY))||Date.now(), latencyMS:0, mode:'cache' }); return s; }catch(e){ return null; } }
      function makeDemoSnapshot(){ var s={ meta:{schema:'tolkar.mes.snapshot.v1',facility:'TOLKAR',generated_at:Date.now(),last_sync_at:Date.now(),source:'/api/mes/snapshot',latency_ms:0,mode:'demo'}, kpis:{co2_today_kg:980,co2_per_unit_kg:21.8,energy_kwh:1240,water_l:2960}, orders:[{order_id:'ORD-1001',line:'Hat-1',station:'S1',status:'AKTIF',progress_pct:65,eta_minutes:45,energy_kwh:12.4,co2e_kg:18.2,risk:'OK'}], timeline:{selected_order_id:'ORD-1001'}, trends:{energy:[],water:[],co2:[]} }; s.orders=expandOrdersToRealistic(s.orders); CONN_STATE.snapshot=s; setConnState('offline',{ lastSyncTS:Date.now(), latencyMS:0, mode:'demo' }); return s; }

      function renderAll(){ var s=CONN_STATE.snapshot||makeDemoSnapshot(); var co2Today=document.getElementById('co2TodayVal'); var co2Unit=document.getElementById('co2UnitVal'); var energy=document.getElementById('energyVal'); var water=document.getElementById('waterVal'); if(co2Today) co2Today.textContent=Math.round(s.kpis.co2_today_kg||0); if(co2Unit) co2Unit.textContent=(s.kpis.co2_per_unit_kg||0); if(energy) energy.textContent=Math.round(s.kpis.energy_kwh||0); if(water) water.textContent=Math.round(s.kpis.water_l||0);
        var unitVal=parseFloat(s.kpis.co2_per_unit_kg||0); var target=20; var unitPill=document.getElementById('co2UnitPill'); var todayPill=document.getElementById('co2TodayPill'); if(unitPill){ if(unitVal<=target*1.05){unitPill.textContent='OK';unitPill.style.background='var(--zero-green)';unitPill.style.color='#fff';} else if(unitVal<=target*1.2){unitPill.textContent='WATCH';unitPill.style.background='var(--zero-orange)';unitPill.style.color='#000';} else {unitPill.textContent='ACTION';unitPill.style.background='var(--zero-red)';unitPill.style.color='#fff';} } if(todayPill){ var t=s.kpis.co2_today_kg||0; if(t<900){todayPill.textContent='OK';todayPill.style.background='var(--zero-green)';todayPill.style.color='#fff';} else if(t<=1200){todayPill.textContent='WATCH';todayPill.style.background='var(--zero-orange)';todayPill.style.color='#000';} else {todayPill.textContent='ACTION';todayPill.style.background='var(--zero-red)';todayPill.style.color='#fff';} }
        renderTimeline(s.orders||[]); renderOrders(s.orders||[]);
      }

      function initApp(){ fetchSnapshot().then(function(){ renderAll(); }).catch(function(){ var cached=loadCachedSnapshot(); if(cached){ renderAll(); } else { makeDemoSnapshot(); renderAll(); } }); }
      document.addEventListener('DOMContentLoaded', initApp);
      setInterval(initApp, 30000);
    })();
  </script>
</body>
</html>
